<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music Taste Similarity</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f8f9fb;
      padding: 2rem;
      color: #222;
      line-height: 1.6;
    }

    /* Headings */
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      font-weight: 700;
      color: #333;
    }
    h2 {
      font-size: 1.5rem;
      margin: 1.5rem 0 1rem;
      font-weight: 600;
      color: #444;
    }

    /* Card-like containers */
    #controls, canvas, #album-list {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    /* Controls */
    #control-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1.5rem;
    }

    select, label {
      font-size: 1rem;
      font-weight: 500;
      color: #333;
    }

    select {
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      transition: border 0.2s ease;
    }
    select:hover {
      border-color: #4caf50;
      cursor: pointer;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 0.4rem;
      cursor: pointer;
      accent-color: #4caf50;
    }

    /* Slider */
    #slider-container {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-top: 1.5rem;
    }
    #slider-range {
      width: 300px;
    }
    .noUi-connect {
      background: linear-gradient(90deg, #4caf50, #e91e63);
    }
    .noUi-handle {
      background: #fff;
      border: 2px solid #4caf50;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: grab;
    }
    .noUi-handle:active {
      cursor: grabbing;
    }
    .noUi-tooltip {
      bottom: -100px;  /* adjust spacing */
      top: auto;
    }

    /* Optional: make the font match your style */
    .noUi-tooltip {
      font-size: 0.85rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 2px 6px;
      color: #333;
    }

    /* Canvas */
    canvas {
      max-height: 600px;
    }

    /* Album list / Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background-color: #f1f1f1;
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background-color: #fafafa;
    }
    tbody tr:hover {
      background-color: #f0f8ff;
      transform: scale(1.01);
      transition: background 0.2s ease, transform 0.15s ease;
      cursor: pointer;
    }

    /* Smooth transitions */
    #controls, canvas, #album-list, select {
      transition: all 0.25s ease;
    }

  </style>
</head>
<body>
  <h1>Music Taste Comparison</h1>
  <div id="controls">
    <div id="control-row">
      <label for="modeSelect">Mode:
        <select id="modeSelect" onchange="updateChart()">
          <option value="similarity">Similarity</option>
          <option value="ratings">Ratings</option>
        </select>
      </label>

      <label for="albumSort">Sort albums:
        <select id="albumSort" onchange="updateChart()">
          <option value="date">By Date</option>
          <option value="release-date">By Release Date</option>
          <option value="mean">By Mean Score</option>
          <option value="yagiz-score">By Yagiz Score</option>
          <option value="tugba-score">By Tugba Score</option>
          <option value="yagba-similarity">By Yagiz vs Tugba</option>
          <option value="tugba-similarity">By Tugba vs Spotify</option>
          <option value="yagiz-similarity">By Yagiz vs Spotify</option>
        </select>
      </label>

      <label for="albumFilter">Filter albums:
        <select id="albumFilter" onchange="updateChart()">
          <option value="all">All Albums</option>
          <option value="odd">Yagiz's Albums</option>
          <option value="even">Tugba's Albums</option>
        </select>
      </label>
    </div>

    <div id="slider-container">
      <div>Filter by date range:</div>
      <div id="slider-range"></div>
      <label><input type="checkbox" id="toggleCumulative" onchange="updateChart()"> Show cumulative means within the selected date range</label>
    </div>
  </div>

  <canvas id="lossChart" width="800" height="400"></canvas>
  <h2>Album List</h2>
  <div id="album-list"></div>

  <script>
    let rawData = [], chartInstance;

    fetch('albums.json')
      .then(res => res.json())
      .then(data => {
        rawData = data.map((d, i) => ({ ...d, index: i }));
        initSlider(rawData.length);
        updateChart();
      });

    function parseDDMMYYYY(dateStr) {
      const [d, m, y] = dateStr.split('.').map(Number);
      return new Date(y, m - 1, d);
    }

    function initSlider(max) {
      const slider = document.getElementById('slider-range');
      noUiSlider.create(slider, {
        start: [1, max],
        connect: true,
        step: 1,
        range: { min: 1, max },
        tooltips: [true, true],
        format: {
          to: v => parseInt(v),
          from: v => parseInt(v)
        }
      });
      slider.noUiSlider.on('change', updateChart);
    }

    function updateChart() {
      const [start, end] = document.getElementById('slider-range').noUiSlider.get().map(Number);
      const filter = document.getElementById('albumFilter').value;
      const sort = document.getElementById('albumSort')?.value || 'date';
      const cumulative = document.getElementById('toggleCumulative').checked;
      const mode = document.getElementById('modeSelect').value;

      const showSim = mode === 'similarity';

      let dataInRange = rawData.slice(start - 1, end);

      if (sort === 'date') dataInRange.sort((a, b) => parseDDMMYYYY(a.date) - parseDDMMYYYY(b.date));
      if (sort === 'release-date') dataInRange.sort((a, b) => parseDDMMYYYY(a.release_date) - parseDDMMYYYY(b.release_date));
      else if (sort === 'mean') dataInRange.sort((a, b) => b.mean_score - a.mean_score);
      else if (sort === 'yagiz-score') dataInRange.sort((a, b) => b.yagiz_score - a.yagiz_score);
      else if (sort === 'tugba-score') dataInRange.sort((a, b) => b.tugba_score - a.tugba_score);
      else if (sort === 'yagba-similarity') dataInRange.sort((a, b) => b.similarity_y_vs_t - a.similarity_y_vs_t);
      else if (sort === 'tugba-similarity') dataInRange.sort((a, b) => b.similarity_t_vs_s - a.similarity_t_vs_s);
      else if (sort === 'yagiz-similarity') dataInRange.sort((a, b) => b.similarity_y_vs_s - a.similarity_y_vs_s);

      const filtered = dataInRange.filter(row => {
        if (filter === 'odd') return (row.index + 1) % 2 === 1;
        if (filter === 'even') return (row.index + 1) % 2 === 0;
        return true;
      });

      const labels = filtered.map(r => r.index + 1);
      const datasets = [];

      if (mode === 'similarity') {
        datasets.push(buildDataset(filtered, 'similarity_y_vs_t', '#3e95cd', 'Yagiz vs Tugba', cumulative));
        datasets.push(buildDataset(filtered, 'similarity_y_vs_s', '#4caf50', 'Yagiz vs Spotify', cumulative));
        datasets.push(buildDataset(filtered, 'similarity_t_vs_s', '#e91e63', 'Tugba vs Spotify', cumulative));
      } else {
        datasets.push(buildDataset(filtered, 'yagiz_score', '#4caf50', "Yagiz's Rating", cumulative));
        datasets.push(buildDataset(filtered, 'tugba_score', '#e91e63', "Tugba's Rating", cumulative));
        datasets.push(buildDataset(filtered, 'mean_score', '#555', 'Average Rating', cumulative));
      }

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(document.getElementById('lossChart').getContext('2d'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 16 } } },
            tooltip: {
              callbacks: {
                title: ctx => filtered[ctx[0].dataIndex].album,
                label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue}`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: (_, i) => labels[i],
                color: ctx => labels[ctx.index] % 2 === 1 ? '#4caf50' : '#e91e63',
                font: { size: 14 }
              },
              title: { display: true, text: 'Album Index', font: { size: 16, weight: 'bold' } }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: mode === 'similarity'
                  ? (cumulative ? 'Cuml. Mean of Music Taste Similarity wrt. Displayed Order' : 'Music Taste Similarity')
                  : (cumulative ? 'Cuml. Mean of Ratings out of 10 wrt. Displayed Order' : 'Ratings out of 10'),
                font: { size: 16, weight: 'bold' }
              },
              ticks: { font: { size: 14 } }
            }
          }
        }
      });

      document.getElementById('album-list').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Artist</th>
              <th>Album</th>
              <th>Release Date</th>
              <th>Date</th>
              <th>Yagiz Score</th>
              <th>Tugba Score</th>
              <th>Mean Score</th>
              <th>Yagiz vs Tugba</th>
              <th>Yagiz vs Spotify</th>
              <th>Tugba vs Spotify</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(album => {
              const c = album.index % 2 === 0 ? '#4caf50' : '#e91e63';
              const slug = album.album.toLowerCase().replace(/ /g, '-').replace(/[^\w-]/g, '');
              return `<tr onclick="location='album.html?album=${slug}'">
                <td style="color:${c}">${album.index + 1}</td>
                <td style="color:${c}">${album.artist}</td>
                <td style="color:${c}">${album.album}</td>
                <td style="color:${c}">${album.release_date}</td>
                <td style="color:${c}">${album.date}</td>
                <td style="color:${c}">${album.yagiz_score.toFixed(1)}</td>
                <td style="color:${c}">${album.tugba_score.toFixed(1)}</td>
                <td style="color:${c}">${album.mean_score.toFixed(1)}</td>
                <td style="color:${c}">${album.similarity_y_vs_t.toFixed(3)}</td>
                <td style="color:${c}">${album.similarity_y_vs_s.toFixed(3)}</td>
                <td style="color:${c}">${album.similarity_t_vs_s.toFixed(3)}</td>
              </tr>`;

            }).join('')}
          </tbody>
        </table>`;
    }

    function buildDataset(data, key, color, label, isCumulative) {
      let values = data.map(r => r[key]);
      if (isCumulative) {
        let sum = 0;
        values = values.map((v, i) => (sum += v) / (i + 1));
      }
      return {
        label,
        data: values,
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.2,
        pointRadius: 5,
        spanGaps: true,
        borderDash: [6, 6]
      };
    }
  </script>
</body>
</html>