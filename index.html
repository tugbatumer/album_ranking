<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music Taste Similarity</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
    }
    canvas {
      max-height: 600px;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #controls {
      margin-bottom: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1.5rem;
    }
    select, label {
      font-size: 1rem;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 0.4rem;
    }
    #slider-range {
      width: 300px;
      margin-right: 1rem;
    }
    #range-values {
      font-size: 1rem;
    }
    #album-list {
      margin-top: 2rem;
      padding-left: 0;
      list-style: none;
      max-width: 800px;
    }
    #album-list li {
      font-size: 1.1rem;
      margin: 0.4rem 0;
      cursor: pointer;
    }
    #album-list li:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Music Taste Similarity per Album</h1>

  <div id="controls">
    <label for="albumFilter">Filter albums:
      <select id="albumFilter" onchange="updateChart()">
        <option value="all">All Albums</option>
        <option value="odd">Yagiz’s Albums</option>
        <option value="even">Tugba’s Albums</option>
      </select>
    </label>

    <div>
      <strong>Show:</strong>
      <label><input type="checkbox" id="toggleYvsT" checked onchange="updateChart()"> Yagiz vs Tugba</label>
      <label><input type="checkbox" id="toggleYvsS" checked onchange="updateChart()"> Yagiz vs Spotify</label>
      <label><input type="checkbox" id="toggleTvsS" checked onchange="updateChart()"> Tugba vs Spotify</label>
    </div>

    <div style="display: flex; align-items: center; gap: 1rem;">
      <div style="margin-right: 0.5rem;">Filter by range:</div>
      <div id="slider-range"></div>
      <div id="range-values" style="display: none;">
        <span id="rangeStartTxt">1</span><span id="rangeEndTxt">1</span>
      </div>
    </div>

    <div>
      <label><input type="checkbox" id="toggleCumulative" onchange="updateChart()"> Show cumulative means within the selected range</label>
    </div>
  </div>

  <canvas id="lossChart" width="800" height="400"></canvas>

  <h2>Album List</h2>
  <ul id="album-list"></ul>

  <script>
    let rawData = [], chartInstance;

    fetch('albums.json')
      .then(r => r.json())
      .then(data => {
        rawData = data.map((d, i) => ({ ...d, index: i }));
        initSlider(rawData.length);
        updateChart();
      });

    function initSlider(maxCount) {
      const slider = document.getElementById('slider-range');
      noUiSlider.create(slider, {
        start: [1, maxCount],
        connect: true,
        step: 1,
        range: { min: 1, max: maxCount },
        tooltips: [true, true],
        format: {
          to: v => parseInt(v),
          from: v => parseInt(v)
        }
      });
      slider.noUiSlider.on('update', (values) => {
        document.getElementById('rangeStartTxt').innerText = values[0];
        document.getElementById('rangeEndTxt').innerText = values[1];
      });
      slider.noUiSlider.on('change', updateChart);
    }

    function updateChart() {
      const [start, end] = document.getElementById('slider-range').noUiSlider.get();
      const mode = document.getElementById('albumFilter').value;
      const isCumulative = document.getElementById('toggleCumulative').checked;

      const filtered = rawData.slice(start - 1, end).filter(r => {
        if (mode === 'odd') return (r.index + 1) % 2 === 1;
        if (mode === 'even') return (r.index + 1) % 2 === 0;
        return true;
      });

      const labels = filtered.map(r => r.index + 1);
      const datasets = [];

      if (document.getElementById('toggleYvsT').checked)
        datasets.push(buildDataset('similarity_y_vs_t', '#3e95cd', filtered, 'Yagiz vs Tugba', isCumulative));
      if (document.getElementById('toggleYvsS').checked)
        datasets.push(buildDataset('similarity_y_vs_s', '#4caf50', filtered, 'Yagiz vs Spotify', isCumulative));
      if (document.getElementById('toggleTvsS').checked)
        datasets.push(buildDataset('similarity_t_vs_s', '#e91e63', filtered, 'Tugba vs Spotify', isCumulative));

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(document.getElementById('lossChart').getContext('2d'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: { font: { size: 16 } }
            },
            tooltip: {
              callbacks: {
                title: ti => filtered[ti[0].dataIndex].album,
                label: t => `${t.dataset.label}: ${t.formattedValue}`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: (_, i) => labels[i],
                color: (context) => {
                  const label = labels[context.index];
                  return label % 2 === 1 ? '#4caf50' : '#e91e63'; // Green for odd, pink for even
                },
                font: { size: 14 }
              },
              title: {
                display: true,
                text: 'Album Index',
                font: { size: 16, weight: 'bold' }
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: isCumulative
                  ? 'Music Taste Similarity (Cumulative Mean Within the Range)'
                  : 'Music Taste Similarity',
                font: { size: 16, weight: 'bold' }
              },
              ticks: { font: { size: 14 } }
            }
          }
        }
      });

      document.getElementById('album-list').innerHTML = filtered.map(r => {
        const clr = r.index % 2 === 0 ? '#4caf50' : '#e91e63';
        const slug = r.album.toLowerCase().replace(/ /g, '-').replace(/[^\w-]/g, '');
        return `<li style="color:${clr}" onclick="location='album.html?album=${slug}'">${r.index + 1}. ${r.album}</li>`;
      }).join('');
    }

    function buildDataset(key, color, filtered, label, isCumulative) {
      let values = filtered.map(r => r[key]);
      if (isCumulative) {
        let cumSum = 0;
        values = values.map((val, idx) => {
          cumSum += val;
          return cumSum / (idx + 1);
        });
      }
      return {
        label,
        data: values,
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.2,
        pointRadius: 5,
        spanGaps: true,
        borderDash: [6, 6]
      };
    }
  </script>
</body>
</html>