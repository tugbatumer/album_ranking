<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music Taste Similarity</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 2rem;
    }
    canvas {
      max-height: 600px;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #controls {
      margin-bottom: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #control-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1.5rem;
    }
    select, label {
      font-size: 1rem;
    }
    input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 0.4rem;
    }
    #slider-container {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-top: 2.2rem;
    }
    #slider-range {
      width: 300px;
    }
    #album-list {
      margin-top: 2rem;
      max-width: 1000px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }
    th, td {
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #ddd;
    }
    tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Music Taste Comparison</h1>
  <div id="controls">
    <div id="control-row">
      <label for="modeSelect">Mode:
        <select id="modeSelect" onchange="updateChart()">
          <option value="similarity">Similarity</option>
          <option value="ratings">Ratings</option>
        </select>
      </label>

      <label for="albumSort">Sort albums:
        <select id="albumSort" onchange="updateChart()">
          <option value="date">By Date</option>
          <option value="release-date">By Release Date</option>
          <option value="mean">By Mean Score</option>
          <option value="yagiz-score">By Yagiz Score</option>
          <option value="tugba-score">By Tugba Score</option>
        </select>
      </label>

      <label for="albumFilter">Filter albums:
        <select id="albumFilter" onchange="updateChart()">
          <option value="all">All Albums</option>
          <option value="odd">Yagiz's Albums</option>
          <option value="even">Tugba's Albums</option>
        </select>
      </label>

        <div id="similarityCheckboxes">
          <strong>Show:</strong>
          <label><input type="checkbox" id="toggleYvsT" checked onchange="updateChart()"> Yagiz vs Tugba</label>
          <label><input type="checkbox" id="toggleYvsS" checked onchange="updateChart()"> Yagiz vs Spotify</label>
          <label><input type="checkbox" id="toggleTvsS" checked onchange="updateChart()"> Tugba vs Spotify</label>
        </div>

        <div id="ratingCheckboxes" style="display: none;">
          <strong>Show:</strong>
          <label><input type="checkbox" id="toggleYR" checked onchange="updateChart()"> Yagiz's Rating</label>
          <label><input type="checkbox" id="toggleTR" checked onchange="updateChart()"> Tugba's Rating</label>
          <label><input type="checkbox" id="toggleAR" checked onchange="updateChart()"> Average Rating</label>
        </div>
    </div>

    <div id="slider-container">
      <div>Filter by date range:</div>
      <div id="slider-range"></div>
      <label><input type="checkbox" id="toggleCumulative" onchange="updateChart()"> Show cumulative means within the selected date range</label>
    </div>
  </div>

  <canvas id="lossChart" width="800" height="400"></canvas>
  <h2>Album List</h2>
  <div id="album-list"></div>

  <script>
    let rawData = [], chartInstance;

    fetch('albums.json')
      .then(res => res.json())
      .then(data => {
        rawData = data.map((d, i) => ({ ...d, index: i }));
        initSlider(rawData.length);
        updateChart();
      });

    function parseDDMMYYYY(dateStr) {
      const [d, m, y] = dateStr.split('.').map(Number);
      return new Date(y, m - 1, d);
    }

    function initSlider(max) {
      const slider = document.getElementById('slider-range');
      noUiSlider.create(slider, {
        start: [1, max],
        connect: true,
        step: 1,
        range: { min: 1, max },
        tooltips: [true, true],
        format: {
          to: v => parseInt(v),
          from: v => parseInt(v)
        }
      });
      slider.noUiSlider.on('change', updateChart);
    }

    function updateChart() {
      const [start, end] = document.getElementById('slider-range').noUiSlider.get().map(Number);
      const filter = document.getElementById('albumFilter').value;
      const sort = document.getElementById('albumSort')?.value || 'date';
      const cumulative = document.getElementById('toggleCumulative').checked;
      const mode = document.getElementById('modeSelect').value;

      const showSim = mode === 'similarity';
      document.getElementById('toggleYvsT').style.display = showSim ? '' : 'none';
      document.getElementById('toggleYvsS').style.display = showSim ? '' : 'none';
      document.getElementById('toggleTvsS').style.display = showSim ? '' : 'none';

      document.getElementById('toggleYR').style.display = !showSim ? '' : 'none';
      document.getElementById('toggleTR').style.display = !showSim ? '' : 'none';
      document.getElementById('toggleAR').style.display = !showSim ? '' : 'none';

      document.getElementById('similarityCheckboxes').style.display = mode === 'similarity' ? 'block' : 'none';
      document.getElementById('ratingCheckboxes').style.display = mode === 'ratings' ? 'block' : 'none';

      let dataInRange = rawData.slice(start - 1, end);

      if (sort === 'date') dataInRange.sort((a, b) => parseDDMMYYYY(a.date) - parseDDMMYYYY(b.date));
      if (sort === 'release-date') dataInRange.sort((a, b) => parseDDMMYYYY(a.release_date) - parseDDMMYYYY(b.release_date));
      else if (sort === 'mean') dataInRange.sort((a, b) => b.mean_score - a.mean_score);
      else if (sort === 'yagiz-score') dataInRange.sort((a, b) => b.yagiz_score - a.yagiz_score);
      else if (sort === 'tugba-score') dataInRange.sort((a, b) => b.tugba_score - a.tugba_score);

      const filtered = dataInRange.filter(row => {
        if (filter === 'odd') return (row.index + 1) % 2 === 1;
        if (filter === 'even') return (row.index + 1) % 2 === 0;
        return true;
      });

      const labels = filtered.map(r => r.index + 1);
      const datasets = [];

      if (mode === 'similarity') {
        if (document.getElementById('toggleYvsT').checked)
          datasets.push(buildDataset(filtered, 'similarity_y_vs_t', '#3e95cd', 'Yagiz vs Tugba', cumulative));
        if (document.getElementById('toggleYvsS').checked)
          datasets.push(buildDataset(filtered, 'similarity_y_vs_s', '#4caf50', 'Yagiz vs Spotify', cumulative));
        if (document.getElementById('toggleTvsS').checked)
          datasets.push(buildDataset(filtered, 'similarity_t_vs_s', '#e91e63', 'Tugba vs Spotify', cumulative));
      } else {
        if (document.getElementById('toggleYR').checked)
          datasets.push(buildDataset(filtered, 'yagiz_score', '#4caf50', "Yagiz's Rating", cumulative));
        if (document.getElementById('toggleTR').checked)
          datasets.push(buildDataset(filtered, 'tugba_score', '#e91e63', "Tugba's Rating", cumulative));
        if (document.getElementById('toggleAR').checked)
          datasets.push(buildDataset(filtered, 'mean_score', '#555', 'Average Rating', cumulative));
      }

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(document.getElementById('lossChart').getContext('2d'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 16 } } },
            tooltip: {
              callbacks: {
                title: ctx => filtered[ctx[0].dataIndex].album,
                label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue}`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: (_, i) => labels[i],
                color: ctx => labels[ctx.index] % 2 === 1 ? '#4caf50' : '#e91e63',
                font: { size: 14 }
              },
              title: { display: true, text: 'Album Index', font: { size: 16, weight: 'bold' } }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: mode === 'similarity'
                  ? (cumulative ? 'Cuml. Mean of Music Taste Similarity wrt. Displayed Order' : 'Music Taste Similarity')
                  : (cumulative ? 'Cuml. Mean of Ratings out of 10 wrt. Displayed Order' : 'Ratings out of 10'),
                font: { size: 16, weight: 'bold' }
              },
              ticks: { font: { size: 14 } }
            }
          }
        }
      });

      document.getElementById('album-list').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Artist</th>
              <th>Album</th>
              <th>Release Date</th>
              <th>Date</th>
              <th>Yagiz Score</th>
              <th>Tugba Score</th>
              <th>Mean Score</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(album => {
              const c = album.index % 2 === 0 ? '#4caf50' : '#e91e63';
              const slug = album.album.toLowerCase().replace(/ /g, '-').replace(/[^\w-]/g, '');
              return `<tr onclick="location='album.html?album=${slug}'">
                <td style="color:${c}">${album.index + 1}</td>
                <td style="color:${c}">${album.artist}</td>
                <td style="color:${c}">${album.album}</td>
                <td style="color:${c}">${album.release_date}</td>
                <td style="color:${c}">${album.date}</td>
                <td style="color:${c}">${album.yagiz_score.toFixed(1)}</td>
                <td style="color:${c}">${album.tugba_score.toFixed(1)}</td>
                <td style="color:${c}">${album.mean_score.toFixed(1)}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
    }

    function buildDataset(data, key, color, label, isCumulative) {
      let values = data.map(r => r[key]);
      if (isCumulative) {
        let sum = 0;
        values = values.map((v, i) => (sum += v) / (i + 1));
      }
      return {
        label,
        data: values,
        borderColor: color,
        backgroundColor: color,
        fill: false,
        tension: 0.2,
        pointRadius: 5,
        spanGaps: true,
        borderDash: [6, 6]
      };
    }
  </script>
</body>
</html>